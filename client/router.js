"use strict";function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(i,!0).forEach(function(t){_defineProperty(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var basePath="",isMove=!1,currentPath="",beforePath="",isPopstate=!1,acuners=[];function Routers(t){var i=this;return this instanceof Routers?Array.isArray(t)?(beforePath=currentPath="",this.routes=t||[],this.ev=/Mobile/i.test(window.navigator.userAgent)?"touchend":"click",this.init(),this._bindPopState(),window.addEventListener("load",function(){i.isLoad=!0;var t=window.location.href.replace(window.location.origin,"");/\/[^\/]+\.html(.+)?/.test(t)&&(basePath=t.replace(/\/[^\/]+\.html(.+)?/,"")),i._replace.call(i,t,!0)}),this.pageX=0,this.pageY=0,document.addEventListener("touchstart",function(t){t.changedTouches&&t.changedTouches[0]&&(i.pageX=t.changedTouches[0].pageX,i.pageY=t.changedTouches[0].pageY)},!0),document.addEventListener("touchmove",function(t){isMove=!0},!0),document.addEventListener("touchend",function(t){if(t.changedTouches&&t.changedTouches[0]){var e=t.changedTouches[0].pageX-i.pageX;isMove=4.2<Math.abs(t.changedTouches[0].pageY-i.pageY)+Math.abs(e)}},!0),this):TypeError("routers must be an Array!"):new Routers(t)}Routers.prototype={constructor:Routers,beforeRouterHooks:[],afterRouterHooks:[],removeEvent:{},store:{},isPopstate:!1,ative:!1,isLoadActve:!1,__state:{},openMove:!1,setState:function(t,e){var i=this;this.__state=this.state,this.state=_objectSpread({},this.state,{},t),"function"==typeof e&&JSON.stringify(this.__state)!==JSON.stringify(this.state)&&(e(this.state),setTimeout(function(t){i.uninstall(),i.initBinding()}))},initBinding:function(){var e=this,t=document.querySelectorAll("a"),i=document.querySelectorAll("[data-to]"),n=Array.prototype.slice;acuners=n.call(t).concat(n.call(i)),this.moveIndex=0,acuners.forEach(function(t){t.__binding||(t.__binding=!0,t.addEventListener(e.ev,e.binding.bind(e)))})},uninstall:function(){var e=this;acuners.forEach(function(t){t.addremoveEventListener&&t.addremoveEventListener(e.ev,e.binding.bind(e))}),acuners=[]},binding:function(t){var e="href",i=t.currentTarget||t.srcElement;"a"!==i.tagName.toLocaleLowerCase()&&(e="data-to");var n=i.getAttribute(e);n&&(/^http(s)?:\/\/.+/.test(n)||t.cancelable&&(t.preventDefault(),this.ative||i.isActive||"click"!==t.type&&(isMove?isMove=!(i.isActive=!0):(this._push.call(this,n=basePath+n),setTimeout(function(t){i&&(i.isActive=null)})))))},setTitle:function(t){document.title=t;var e=document.createElement("iframe");e.style.display="none",e.onload=function(){setTimeout(function(){e.remove()},9)},document.body.appendChild(e)},init:function(){this._routes=this.routes.slice();for(var t=0;t<this._routes.length;t++){var e=this._routes[t];e.children&&(this._routes=this._routes.concat(e.children))}},hook:function(t,e){for(var i=0;i<this._routes.length;i++){this.routes[i].path===t&&(this._routes[i].callback=e)}},addEventListener:function(t,e,i,n){var o=3<arguments.length&&void 0!==n&&n;t instanceof HTMLElement?(t.addEventListener&&t.addEventListener(e,i,o),this.addremoveEventListener(this.pathStr,t,e,i,o)):console.log("element Can't be "+t)},addremoveEventListener:function(t,e,i,n,o){this.removeEvent[t]||(this.removeEvent[t]=[]),this.removeEvent[t].push({element:e,type:i,listener:n,useCapture:o})},beforeRouter:function(t){"function"==typeof t&&this.beforeRouterHooks.push(t)},afterRouter:function(t){"function"==typeof t&&this.afterRouterHooks.push(t)},createContext:function(e){var i=this,t=_objectSpread({},this,{},Object(e)),n=Object.getOwnPropertyNames(this.__proto__),o=Object.getOwnPropertyNames(e.__proto__),r={};return n.forEach(function(t){"constructor"!==t&&(r[t]=i[t])}),o.forEach(function(t){r[t]=e[t]}),t.__proto__=r,t},isRun:!1,go:function(t,e){var i=this;this.isRun=!0;var n=this.find(t);isPopstate=!1;var o={},r={};if(n&&n.callback&&n.callback.el&&("function"==typeof(o=n.callback).el&&(this.pathStr=t,r=new o.el(this)),n.callback.context=null,n.callback.context=this.createContext(r)),this.isBlock)this.isBlock=!1;else{this.openMove=!1,r.beforeMount&&r.beforeMount.call(n.callback.context,this);var s=this.removeEvent[this.beforeRouter];if(s&&(s&&s.forEach(function(t){var e=t.element;e.removeEventListener&&e.removeEventListener(t.type,t.listener,t.useCapture)}),this.removeEvent[this.beforeRouter]=[]),beforePath&&beforePath!==t){var a=this.find(beforePath);a&&a.callback&&a.callback.el&&beforeRouterFn.destroyed&&beforeRouterFn.destroyed.call(a.callback.context)}if(this.isBlock)this.isBlock=!1;else{var c=document.querySelector("[data-router]");this.uninstall(),currentPath===t||isPopstate||("pushState"===e?window.history.pushState({path:t},null,t):"replaceState"===e&&window.history.replaceState({path:t},null,t)),this.isLoad||n.callback&&(c.innerHTML=n.callback.__html,n.callback.__title&&this.setTitle(n.callback.__title)),this.initBinding(),beforePath=this.currentPath,setTimeout(function(t){r.mounted&&i.isRun&&(r.mounted.call(n.callback.context),i.isBlock&&(i.isBlock=!1))}),this.ative=!1,currentPath=t,this.isLoad=!1}}},_next:function(e,i){var n=this,o=this.find(e),r=this;if(o&&o.import){if(o.isLoad)return;o.isLoad=!0,o.import().then(function(t){r.go&&r.go.call(n,e,i),n.isNext&&(n.isNext=!1,n.isBlock=!0),o.isLoad=!1},function(t){console.error("".concat(o.path," import errorï¼š"),t)})}},pushNext:function(t){return this._next.call(this,t,"pushState")},replaceNext:function(t){return this._next.call(this,t,"replaceState")},to:function(t,e){this.isRun=!1;var i=this;this.beforeRouterHooks.forEach(function(t){i.isRun||t.call(i,e.bind(this),beforePath,currentPath)}),this.isRun||e.call(i,t),this.isRun=!1,this.afterRouterHooks.forEach(function(t){i.isRun||t.call(i,e.bind(this),beforePath,currentPath)})},_push:function(t){this.isLoad=!1,this.to.call(this,t,this.pushNext.bind(this))},push:function(t){this._push.call(this,t),this.isNext=!0},_replace:function(t){this.isLoad=!1,this.to.call(this,t,this.replaceNext.bind(this))},replace:function(t){this._replace.call(this,t),this.isNext=!0},find:function(e){return this._routes.find&&this._routes.find(function(t){return t.path===e||(-1<e.search(t.path)||void 0)})},_bindPopState:function(){var i=this;window.addEventListener("popstate",function(t){var e=t.state&&t.state.path;e=e||window.location.href.replace(window.location.origin,""),i._replace.call(i,e,isPopstate=!0)})}},module.exports=Routers;
